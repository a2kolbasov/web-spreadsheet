<!--
  ~ Copyright © 2020 Aleksandr Kolbasov
  -->

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
</head>
<body>


<div id="tables">
    <table>
        <tr v-for="(row, rowId) of arr">
            <td v-for="(value, colId) of row">
                <b v-if="rowId == 0 || colId == 0">{{value}}</b>
                <input v-else type="text" v-model="arr[rowId][colId]"/>
            </td>
        </tr>
    </table>

    <button @click="canExportResults = false" onclick="resize()">Изменить размер</button>
    <div>
        <input type="file" id="fileImport" style="display: none;"> <!-- TODO: accept="text/csv" -->
        <button @click="canExportResults = false" onclick="csvImport()">Import CSV</button>
        <button onclick="csvExport()">Export CSV</button>
    </div>

    <br>
    <button @click="canExportResults = true" onclick="calc()">Вычислить</button>

    <table v-if="canExportResults">
        <tr v-for="(row, rowId) of calcArr">
            <td v-for="(value, colId) of row">
                <b v-if="rowId == 0 || colId == 0">{{arr[rowId][colId]}}</b>
                <input v-else-if="calcArr[rowId][colId].error" v-model="calcArr[rowId][colId].value" style="color: red;"/>
                <input v-else type="text" v-model="calcArr[rowId][colId].value"/>
            </td>
        </tr>
    </table>

    <button v-if="canExportResults" onclick="csvExportResults()">Экспорт результатов</button>
</div>

<!-- Vue.js -->
<!-- development version, includes helpful console warnings -->
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script>
    'use strict';
    ////////////////////////////////
    // Init block
    ////////////////////////////////
    let vue = new Vue({
        el: '#tables',
        data: {
            arr: [[]],
            calcArr: [[]],
            canExportResults : false,
        },
        methods: {
        }
    });
    // Начальное значение
    resize(5, 5);

    ////////////////////////////////
    // Для построения таблиц
    ////////////////////////////////

    // Меняем размер главной таблицы
    function resize(rows, columns) {
        let arr = vue._data.arr;
        if (rows === undefined || columns === undefined) {
            rows = +prompt('Кол-во строк', '5');
            columns = +prompt('Кол-во столбцов', '5');
        }

        // + 1 для названий строк и столбцов
        rows = rows > 0 ? rows + 1 : 2;
        columns = columns > 0 ? columns + 1 : 2;

        // console.log(`rows: ${rows} columns: ${columns} (+ 1 for row & column names)`);

        let newArr = [[]];
        /*
        # A B
        1 ` `
        2 ` `
         */
        for (let row = 0; row < rows; row++) {
            newArr[row] = row === 0 ? ['#'] : [row];
            // console.log(newArr.toString());
            for (let col = 1; col < columns; col++) {
                if (row === 0) {
                    newArr[row][col] = toAlpha(col);
                } else {
                    newArr[row][col] =
                        (arr[row] === undefined || arr[row][col] === undefined) ?
                            '' : arr[row][col];
                }
            }
        }
        vue._data.arr = newArr;
    }

    // Перевод id ячейки в букву (для обозначения столбцов)
    // 1 -> A, 26 -> Z, 27 -> AA...
    function toAlpha(number) {
        let alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        let result = '';
        while (number > 0) {
            number--;
            // console.log((number ) % alphabet.length);
            result += alphabet[number % alphabet.length];
            // console.log(result);
            number = Math.floor(number / alphabet.length);
            // console.log(number);
        }
        return result.split('').reverse().join('');
    }

    // Перевод названия столбца в его id
    function toNumber(alphas) {
        alphas = alphas.toString().toUpperCase().split('');
        // console.log(`alphas: ${alphas}, length: ${alphas.length}`);
        let alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        let result = 0;
        for (let alpha of alphas) {
            // console.log(`alpha: ${alpha}`);
            if (result !== 0) result *= alphabet.length;
            result += alphabet.indexOf(alpha) + 1;
            // console.log(`result: ${result}`);
        }
        return result;
    }

    function calc() {
        let arr = vue._data.arr;
        //

        //
        vue._data.calcArr = arr.slice();
        throw 'todo' // todo
    }

    ////////////////////////////////
    // CSV
    ////////////////////////////////

    function csvImport() {
        // https://developer.mozilla.org/ru/docs/Web/API/File/Using_files_from_web_applications

        let fileImport = document.getElementById('fileImport');
        fileImport.click();
        let file = fileImport.files[0];

        // file.data.toString();
        console.log(file.data.toString());

        throw 'todo' // todo
    }

    function csvExport() {
        throw 'todo' // todo
    }

    function csvExportResults() {
        throw 'todo' // todo
    }

</script>

</body>
</html>
